const _={ATTACK:{start:0,end:.2},BODY:{start:.2,end:1},FINISH:{start:1}},It={SIGMA_MULTIPLE:3},k=6.7,ft=.05,et=5,dt=10,L={LOW:5,MEDIUM:10,HIGH:20,VERY_HIGH:30,DOMINANT:50},x={LOW:5,MEDIUM:15,HIGH:25,VERY_HIGH:40,DOMINANT:60},ut={acidity:["acidity","fresh_fruit"],cacao:["cacao","browned_fruit","nutty"],roast:["roast","caramel"],bitterness:["bitterness","vegetal","woody"],astringency:["astringency","spice"]},U=["cacao","acidity","bitterness","astringency","roast"],ht=["fresh_fruit","browned_fruit","vegetal","floral","woody","spice","nutty","caramel","sweetness"],J=["defects"],mt=[...U,...ht,...J],f=(t,a,s,o,r)=>{const n=Math.max(a,Math.min(s,t));return o+(n-a)/(s-a)*(r-o)},at=(t,a,s="expert")=>a==="defect"?t===0?0:t<=3?1:t<=k?2:t<=15?Math.round(f(t,k,15,3,5)):t<=30?Math.round(f(t,16,30,6,8)):Math.round(f(t,31,60,9,10)):s==="normal"&&a==="core"?t<=1.5?0:t<=10?1:t<=19?2:t<=35?Math.round(f(t,20,35,3,4)):t<=60?Math.round(f(t,36,60,5,7)):Math.round(f(t,61,90,8,10)):a==="complementary"?t<1.5?0:t<=4?1:t<=k?2:t<=15?Math.round(f(t,k,15,3,4)):t<=30?Math.round(f(t,16,30,5,7)):Math.round(f(t,31,60,8,10)):t<2?0:t<=k?1:t<=20?Math.round(f(t,k,20,2,3)):t<=40?Math.round(f(t,21,40,4,6)):Math.round(f(t,41,80,7,10)),u={attack:_.ATTACK,body:_.BODY,finish:_.FINISH},st=(t,a)=>a===0?t>0?1:0:t/a,gt=(t,a)=>{const s=st(t.start,a),o=st(t.end,a),r={attack:0,body:0,finish:0};if(s<u.attack.end&&o>u.attack.start){const n=Math.max(s,u.attack.start),h=Math.min(o,u.attack.end);r.attack=(h-n)*a}if(s<u.body.end&&o>u.body.start){const n=Math.max(s,u.body.start),h=Math.min(o,u.body.end);r.body=(h-n)*a}if(o>u.finish.start){const n=Math.max(s,u.finish.start);r.finish=(o-n)*a}return r},yt=(t,a)=>{const s=new Map,o=new Map,r=new Map;for(const n of t){const h=gt(n,a);s.set(n.attrId,(s.get(n.attrId)||0)+h.attack),o.set(n.attrId,(o.get(n.attrId)||0)+h.body),r.set(n.attrId,(r.get(n.attrId)||0)+h.finish)}return{attack:s,body:o,finish:r}},K=(t,a)=>{if(a<=et||t<=0)return 0;let s=0;return t>dt?s+=2:t>et&&(s+=1),t/a>.5&&(s+=1),s},Mt=t=>{var P;const{events:a,swallowTime:s,totalDuration:o,mode:r}=t,n=s===null||s===0?o:s,h=o;let T=0;a.length>0&&(T=Math.min(...a.map(e=>e.start)));const m=Math.max(0,n-T),ot=Math.max(0,h-T),it=a.map(e=>({...e,start:Math.max(0,e.start-T),end:Math.max(0,e.end-T)})),i=yt(it,m),b=m*_.ATTACK.end,X=m*(_.BODY.end-_.BODY.start),g=Math.max(0,ot-m),v=new Map,nt=r==="normal"?[...U,...J]:mt;for(const e of nt){const l=i.body.get(e)||0,d=i.attack.get(e)||0,E=i.finish.get(e)||0,B=d+l,H=m>0?B/m*100:0,Q=J.includes(e),C=U.includes(e),N=Q?"defect":C?"core":"complementary";let j=at(H,N,r);const W=K(E,g);let R;W>0&&(R={amount:W,duration:Math.round(E*10)/10,type:"individual",reason:"aftertaste"});const O=B+E,G=Math.min(H,100);v.set(e,{score:j,durationPercent:Math.round(G*10)/10,totalDuration:Math.round(O*10)/10,isPresent:O>ft,isFlagged:C&&G===0,category:N,originalScore:void 0,boostDetails:R,zoneBreakdown:{attack:b>0?Math.round(d/b*1e3)/10:0,body:X>0?Math.round(l/X*1e3)/10:0,finish:g>0?Math.round(E/g*1e3)/10:0}})}const F=new Map;if(r==="expert")for(const e of U){const l=i.body.get(e)||0,d=i.attack.get(e)||0,E=l+d,B=ut[e]||[];let H=0,Q=0;if(B.length>0)for(const lt of B){const q=i.finish.get(lt)||0;q>0&&(H+=q,Q+=K(q,g))}const C=E,N=m>0?C/m*100:0;let j=at(N,"core","expert");const W=j,R=i.finish.get(e)||0,O=K(R,g),G=O+Q;let tt;G>0&&(tt={amount:G,duration:Math.round((R+H)*10)/10,type:"aggregated",reason:O>0?"aftertaste":"mixed"}),F.set(e,{score:j,durationPercent:Math.round(N*10)/10,totalDuration:Math.round(C*10)/10,isPresent:C>0,isFlagged:N===0,category:"core",originalScore:W,boostDetails:tt})}else for(const e of U){const l=v.get(e);l?F.set(e,l):F.set(e,{durationPercent:0,totalDuration:0,isPresent:!1,isFlagged:!0,category:"core",score:0})}const $=[];let y=0;for(const[e,l]of i.attack){const d=b>0?l/b*100:0;d>10&&$.push(e),d>y&&(y=d)}let p=3;y>L.DOMINANT?p=8:y>L.VERY_HIGH?p=7:y>L.HIGH?p=6:y>L.MEDIUM?p=5:y>L.LOW?p=4:y===0&&(p=2);let I=0,w=null;for(const[e,l]of i.finish){const d=g>0?l/g*100:0;d>I&&(I=d,w=e)}let D=3;I>x.DOMINANT?D=8:I>x.VERY_HIGH?D=7:I>x.HIGH?D=6:I>x.MEDIUM?D=5:I>x.LOW&&(D=4);const rt=["cacao","fresh_fruit","browned_fruit","floral","caramel","sweetness","nutty"],ct=["defects","astringency","bitterness"];let S="neutral";g>2&&I<10?S="positive":w&&(rt.includes(w)?S="positive":ct.includes(w)&&(S="negative"));let z=0;S==="positive"&&(z+=.5),S==="negative"&&(z-=1.5),p>=7&&(z+=.5);const A=[],V=b*.5;i.attack.size>0&&((i.attack.get("acidity")||0)>V&&A.push({en:"High acidity in the attack often indicates Fruit notes. Did you perceive Citrus (Lemon/Lime) or Berry?",es:"Alta acidez en el ataque a menudo indica notas frutales. ¿Percibiste cítricos (limón/lima) o bayas?"}),(i.attack.get("bitterness")||0)>V&&A.push({en:"Strong early bitterness can indicate 'Green/Vegetal' notes (if raw) or 'Coffee/Burnt' notes (if roasted). Check these categories.",es:"Un fuerte amargor inicial puede indicar notas 'Verdes/Vegetales' (si es crudo) o 'Café/Quemado' (si es tostado). Revisa estas categorías."}),(i.attack.get("astringency")||0)>V&&A.push({en:"Sharp astringency often comes from 'Nut Skins' or 'Unripe Fruit'. Consider adding these to the profile.",es:"La astringencia aguda a menudo proviene de 'Pieles de nuez' o 'Fruta verde'. Considera agregar estos al perfil."}),(i.attack.get("floral")||0)>b*.1&&A.push({en:"Floral notes often carry subtle 'Spicy' (Coriander) or 'Light Wood' nuances. Did you perceive them?",es:"Las notas florales a menudo conllevan matices sutiles de 'Especias' (cilantro) o 'Madera ligera'. ¿Los percibiste?"}),(i.attack.get("sweetness")||0)>V&&A.push({en:"Sweetness in dark chocolate is often aromatic. Check for 'Caramel/Panela', 'Malt', or 'Vanilla'.",es:"El dulzor en el chocolate oscuro suele ser aromático. Busca 'Caramelo/Panela', 'Malta' o 'Vainilla'."}));const M=[],c=e=>(i.finish.get(e)||0)>0,Y=((P=v.get("defects"))==null?void 0:P.score)||0;Y>0&&(Y>=3?M.push({en:"Defect Intensity 3+ (Clearly characterizing). Recommend Global Quality 0-3.",es:"Intensidad de defecto 3+ (Claramente característico). Se recomienda Calidad Global 0-3."}):Y>=1&&M.push({en:"Defect Intensity 1-2 (Low intensity). Recommend Global Quality 4-6.",es:"Intensidad de defecto 1-2 (Baja intensidad). Se recomienda Calidad Global 4-6."})),Y===0&&S==="positive"&&p>=5&&M.push({en:"Clean sample (Absent defects). Recommend Global Quality 7-10.",es:"Muestra limpia (Defectos ausentes). Se recomienda Calidad Global 7-10."}),c("acidity")&&c("bitterness")&&!c("fresh_fruit")&&!c("browned_fruit")&&i.finish.get("acidity")+i.finish.get("bitterness")>g*.5&&(r==="expert"?M.push({en:"Unbalanced, harsh finish (Sour+Bitter without Fruit). Suggest Low Quality.",es:"Final desequilibrado y áspero (Acidez+Amargor sin fruta). Sugiere Baja Calidad."}):M.push({en:"Harsh finish (Sour+Bitter). If no Fruit was perceived, suggest Low Quality.",es:"Final áspero (Acidez+Amargor). Si no se percibió fruta, sugiere Baja Calidad."})),c("fresh_fruit")&&c("acidity")&&c("sweetness")&&M.push({en:"Bright, complex finish detected (Fruit+Acid+Sweet). Suggest Global Quality 8–10.",es:"Final brillante y complejo detectado (Fruta+Acidez+Dulzor). Sugiere Calidad Global 8–10."}),r==="normal"&&c("acidity")&&c("cacao")&&!c("bitterness")&&!c("astringency")&&M.push({en:"Clean Cacao + Acidity finish detected. If fruity notes were present, consider Global Quality 8-10.",es:"Final limpio de Cacao + Acidez. Si hubo notas frutales, considera Calidad Global 8-10."}),c("cacao")&&c("nutty")&&(c("woody")||c("spice"))&&M.push({en:"Solid, comforting cacao base (Cocoa+Nutty+Woody). Suggest Global Quality 7–9.",es:"Base de cacao sólida y reconfortante (Cacao+Nuez+Madera). Sugiere Calidad Global 7–9."});const Z=[];return v.forEach((e,l)=>{e.boostDetails&&e.boostDetails.amount>0&&Z.push({attrId:l,amount:e.boostDetails.amount})}),F.forEach((e,l)=>{e.boostDetails&&e.boostDetails.amount>0&&Z.push({attrId:l,amount:e.boostDetails.amount})}),{scores:v,coreScores:F,aromaIntensity:p,aromaPercent:Math.round(y*10)/10,aromaNotes:$,aftertasteIntensity:D,aftertastePercent:Math.round(I*10)/10,aftertasteQuality:S,dominantAftertaste:w,aftertasteBoosts:Z,kickSuggestions:A,qualitySuggestions:M,qualityModifier:z,firstOnset:T,attackPhaseDuration:b,adjustedSwallowTime:m}},bt=(t,a)=>t.map(s=>{const o=a.get(s.id);return o!==void 0?{...s,score:o.score}:s});export{U as C,J as D,It as T,Mt as a,bt as b};
